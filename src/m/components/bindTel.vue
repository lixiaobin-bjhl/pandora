<style>
    @import "../../../static/css/icomoon/style.css";  
</style>
<template>
	<div>
		<div class="fields">
			<div class="profile">
				<img width="60" height="60" :src="info.consulter.avatar">
				<ul>
					<li class="name">{{info.consulter.name}}</li>
					<li class="gray999">{{info.orgName || '医院名称'}}</li>
				</ul>
			</div>
			<div class="notice">
				<ol>
					<p>请填写真实信息，便于医院：</p>
					<li>① 联系您</li>
					<li>② 对您的术后情况作出更准确评估</li>
				</ol>
			</div>
			<div class="login-form">
				<mt-field class="mobile-field" :disable-clear="true"  v-model="name" placeholder="姓名"></mt-field>
				<mt-field class="mobile-field" :disable-clear="true"  v-model="mobile" placeholder="手机号" type="tel"></mt-field>
				<mt-field class="mobile-field" :disable-clear="true" type="tel"  v-model.number="age" placeholder="年龄"></mt-field>
				<div class="gender-wrap">
					<label><input v-model="gender" :value="1" name="gender" type="radio">男</input></label>
					<label><input v-model="gender" :value="2" name="gender" type="radio">女</input></label>
				</div>
			</div>
		</div>
		<div class="footer">
			<mt-button type="primary" class="btn-submit" :disabled="submiting" @click.native="bind">确定</mt-button>
		</div>
	</div>
</template>
<script>
	import MtButton from 'mint-ui/lib/button';
	import MtField from 'mint-ui/lib/field';
	import Toast from 'mint-ui/lib/toast';
	import 'mint-ui/lib/button/style.css';
	import 'mint-ui/lib/field/style.css';
	import 'mint-ui/lib/toast/style.css';
	import { Indicator } from 'mint-ui';
	import redirect from '../../common/function/redirect';
	import  {bindWechat, getLoginUser} from '../request';

	export default {
		data() {
			return {
				mobile: '',
				name: '',
				age: '',
				gender: '',
				submiting: false,
				info: {
					consulter: {}
				},
				timer: null
			}
		},
		created () {
			this.getLoginUser();
			// this.query = getUrlSearch();
		},
		methods: {
			/**
			 * 获取登录者信息 
			 */
			getLoginUser () {
				Indicator.open('加载中…');
				getLoginUser()
					.then((res)=>{
						this.info = res.data;
						Indicator.close();
					})
					.catch(()=> {
						Indicator.close();
					});
			},
			timeStep() {
				this.count--;
				this.codeTip = `重新获取(${this.count}s)`;
				if (this.count < 1 && this.timer) {
					clearInterval(this.timer);
					this.getCoding = false;
					this.codeTip = `获取验证码`;
					this.waiting = false;
				}
			},
			startTimer() {
				this.waiting = true;
				this.codeTip = `重新获取(${this.count}s)`;
				this.timer = setInterval(() => {
					this.timeStep();
				}, 1000);
				this.timeStep();

			},
			getCode() {
				if (this.getCoding || this.waiting) {
					return;
				} else {
					if (this.mobile == '') {
						Toast('请填写手机号');
						return;
					}
					if (!(/^1[34578]\d{9}$/.test(this.mobile))) {
						Toast('请输入正确的手机号');
						return;
					}

					let params = {
						mobile: this.mobile,
						userRole: this.query.userRole
					};
					this.count = 60;
					this.getCoding = true;
					sendCode(params)
						.then((res) => {
							Toast('验证码已发送');
							this.startTimer();
						}, () => {
							this.getCoding = false;
						});
				}
			},
			bind() {
				if (this.name == '') {
					Toast('请填写姓名');
					return;
				}
				if (this.mobile == '') {
					Toast('请填写手机号');
					return;
				}
				if (!(/^1[34578]\d{9}$/.test(this.mobile))) {
					Toast('请填写正确的手机号');
					return;
				}
				if (this.age == '') {
					Toast('请填写年龄');
					return;
				}
				if (!this.gender) {
					Toast('请选择性别');
					return;
				}
				this.submiting = true;
				Indicator.open('加载中…');
				let params = {
					mobile: this.mobile,
					name: this.name,
					age: this.age,
					gender: this.gender
				}
				bindWechat(params)
					.then((res) => {
						Toast('绑定成功');
						redirect('chat.html');
					})
					.catch(() => {
						Indicator.close();
						this.submiting = false;
					});
				
			}
		},
		components: {
			MtButton,
			MtField
		}
	}
</script>